<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="../static/fonts/AtkinsonHyperlegible.css"/>
    <link rel="stylesheet" href="../static/fonts/RobotoMono.css"/>
    <link rel="stylesheet" href="../static/style.css"/>
    <script src="../static/scripts/socket.io.js"></script>
    <script src="../static/scripts/point.js"></script>
    <script type="text/javascript">
        var socket = io();
        let points = [new Point(0, 0)];

        setInterval(function() {
            if (socket.connected) {
                socket.emit('pos', {});
            }
        }, 20)

        socket.on('pos', function(msg) {
            data = JSON.parse(msg.data);
            var table = document.getElementsByClassName("inner-table").item(0).firstElementChild;
            var row = table.insertRow(0);
            var tsCell = row.insertCell(0);
            var codeCell = row.insertCell(1);
            var msgCell = row.insertCell(2);
            
            tsCell.style.width = "15%";
            codeCell.style.width = "10%";
            msgCell.style.width = "75%";

            tsCell.innerHTML = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false });
            codeCell.innerHTML = "1";
            msgCell.innerHTML = msg.data;

            while (table.rows.length > 10) {
                table.deleteRow(table.rows.length - 1);
            }

            points.push(new Point(data[0], data[1]));
            points = points.slice(-500);
        });
        
        window.onload = function() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const pxToFeet = 50;
            const screenSpaceToWorldSpace = (point) => {
                return Point.add(Point.mul(point, pxToFeet), new Point(canvas.width/2, canvas.height/2));
            }
            let canvasWidthUnits = canvas.width/pxToFeet;
            let canvasHeightUnits = canvas.height/pxToFeet;
            
            function drawLine(a, b) {
                ctx.beginPath();
                ctx.moveTo(a.x, a.y);
                ctx.lineTo(b.x, b.y);
                ctx.stroke();
                ctx.closePath();
            }
            function drawTri(p, width, height, angle) {
                ctx.translate(p.x, p.y);
                ctx.rotate(angle);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(height, 0);
                ctx.lineTo(0, width);
                ctx.lineTo(-height, 0);
                ctx.fill();
                ctx.closePath();
                ctx.resetTransform();
            }

            update();

            window.onresize = function() {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                canvasWidthUnits = canvas.width / pxToFeet;
                canvasHeightUnits = canvas.height / pxToFeet;
            }
            window.onresize();
            
            function update() {
                var p = screenSpaceToWorldSpace(points[points.length - 1]);
                p = Point.sub(p, new Point(canvas.width/2, canvas.height/2));
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.translate(-p.x, -p.y);
                
                ctx.strokeStyle = "white";
                ctx.lineThickness = 2;
                // console.log(points)
                for (let i = 0; i < points.length - 1; i++) {
                    drawLine(screenSpaceToWorldSpace(points[i]), screenSpaceToWorldSpace(points[i+1]));
                }

                ctx.resetTransform()
                
                if (points.length > 1) {
                    ctx.fillStyle = "white";
                    drawTri(new Point(canvas.width/2, canvas.height/2), 10, 5, (Point.sub(points[points.length - 1], points[points.length - 2])).getAngle() - Math.PI / 2)
                }
                
                window.requestAnimationFrame(update);
            }
        }
    </script>
</head>
<body>
    <div id="top-bar">
        <img id="icon" src="../static/images/icon-small.png"/>
        <span id="icon-text">KDriver Station</span>
    </div>
    <div id="container">
        <div id="left">
            <div id="img-container">
                <!-- <img id="img-stream"  src="{{ url_for('stream') }}" onerror="this.src='../static/images/no-cam.png'"></img> -->
            </div>
            <div id="ws-logs-container">
                <table id="ws-logs-header" class="head">
                    <tr>
                        <td style="width: 15%;">Time</td>
                        <td style="width: 10%;">Code</td>
                        <td style="width: 75%;">Message</td>
                    </tr>
                </table>
                <div class="inner-table">
                <table>
                    <tr>
                        <td style="width: 15%;">12:12:12</td>
                        <td style="width: 10%;">404</td>
                        <td style="width: 75%;">test msg</td>
                    </tr>
                </table>
                </div>
                <div class="table-footer"></div>
            </div>
        </div>
        <div id="mid"></div>
        <div id="right">
            <canvas id="canvas" style="width: 100%; aspect-ratio: 2.5; background-color: var(--dark2);"></canvas>
        </div>
    </div>
</body>
</html>